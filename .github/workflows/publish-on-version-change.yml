# libs.versions.tomlì˜ sdk_version ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ GitHub Packagesì— ë°°í¬í•˜ëŠ” ì›Œí¬í”Œë¡œìš°
name: Publish to GitHub Packages on Version Change

# íŠ¸ë¦¬ê±° ì¡°ê±´: release ë¸Œëœì¹˜ì—ì„œ libs.versions.toml íŒŒì¼ì´ ë³€ê²½ëœ ê²½ìš°
on:
  push:
    branches:
      - 'release/**'  # releaseë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ë¸Œëœì¹˜ì—ì„œ ì‹¤í–‰
      - 'feature/**'
    paths:
      - 'gradle/libs.versions.toml'  # ì´ íŒŒì¼ì´ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰

# GitHub Actionsì—ì„œ í•„ìš”í•œ ê¶Œí•œ ì„¤ì •
permissions:
  contents: write    # ë¦´ë¦¬ì¦ˆ ìƒì„±ì„ ìœ„í•´ í•„ìš”
  packages: write    # GitHub Packages ë°°í¬ë¥¼ ìœ„í•´ í•„ìš”

jobs:
  # ì²« ë²ˆì§¸ ì‘ì—…: sdk_versionì´ ì‹¤ì œë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
  check-version-change:
    runs-on: ubuntu-latest
    outputs:
      version-changed: ${{ steps.version-check.outputs.changed }}  # ë²„ì „ ë³€ê²½ ì—¬ë¶€ë¥¼ ë‹¤ìŒ ì‘ì—…ì— ì „ë‹¬
      new-version: ${{ steps.version-check.outputs.version }}      # ìƒˆ ë²„ì „ ê°’ì„ ë‹¤ìŒ ì‘ì—…ì— ì „ë‹¬
    steps:
      # ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒ (ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´ ê¹Šì´ë¥¼ 2ë¡œ ì„¤ì •)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # í˜„ì¬ì™€ ì´ì „ ì»¤ë°‹ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•¨

      # sdk_versionì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë‹¨ê³„
      - name: Check if sdk_version changed
        id: version-check
        run: |
          # í˜„ì¬ ì»¤ë°‹ì˜ sdk_version ê°’ ì¶”ì¶œ
          CURRENT_VERSION=$(grep "sdk_version" gradle/libs.versions.toml | cut -d '"' -f 2)
          echo "Current version: $CURRENT_VERSION"

          # ì´ì „ ì»¤ë°‹ì˜ sdk_version ê°’ ì¶”ì¶œ
          git checkout HEAD~1 -- gradle/libs.versions.toml 2>/dev/null || echo "No previous version found"
          PREVIOUS_VERSION=$(grep "sdk_version" gradle/libs.versions.toml | cut -d '"' -f 2 2>/dev/null || echo "")
          echo "Previous version: $PREVIOUS_VERSION"

          # í˜„ì¬ ë²„ì „ìœ¼ë¡œ íŒŒì¼ ë³µì›
          git checkout HEAD -- gradle/libs.versions.toml

          # ë²„ì „ì´ ë³€ê²½ë˜ì—ˆê³  ìœ íš¨í•œ ê°’ì¸ì§€ í™•ì¸
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ] && [ -n "$CURRENT_VERSION" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Version not changed"
          fi

  # ë‘ ë²ˆì§¸ ì‘ì—…: ë²„ì „ì´ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ GitHub Packagesì— ë°°í¬
  publish:
    needs: check-version-change  # ì´ì „ ì‘ì—…ì´ ì™„ë£Œëœ í›„ ì‹¤í–‰
    if: needs.check-version-change.outputs.version-changed == 'true'  # ë²„ì „ì´ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest
    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # Java 11 ì„¤ì • (Android í”„ë¡œì íŠ¸ ë¹Œë“œë¥¼ ìœ„í•´ í•„ìš”)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Gradle ìºì‹œ ì„¤ì •ìœ¼ë¡œ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # gradlew ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # GitHub Packages ë°°í¬ë¥¼ ìœ„í•œ ì¸ì¦ ì •ë³´ ìƒì„±
      - name: Create github.properties
        run: |
          echo "url=https://maven.pkg.github.com/${{ github.repository }}" > github.properties
          echo "github_username=${{ github.actor }}" >> github.properties
          echo "github_token=${{ secrets.DONGLAB_DEVTOOLS_GITHUB_TOKEN }}" >> github.properties

      # ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹Œë“œ ë° GitHub Packagesì— ë°°í¬
      - name: Build and publish to GitHub Packages
        run: ./gradlew publishReleasePublicationToMavenRepository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ìƒˆ ë²„ì „ìœ¼ë¡œ GitHub Release ìƒì„±
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-version-change.outputs.new-version }}
          name: Release v${{ needs.check-version-change.outputs.new-version }}
          body: |
            SDK version updated to ${{ needs.check-version-change.outputs.new-version }}

            Published to GitHub Packages automatically.

            ### ğŸ“¦ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì ìš© ë°©ë²•

            **1. GitHub Token ì„¤ì •**
            - GitHub Packagesë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ Personal Access Tokenì´ í•„ìš”í•©ë‹ˆë‹¤.

            **2. Gradle ì„¤ì •**
            ```kotlin
            # settings.gradle.kts
            dependencyResolutionManagement {
              repositories {
                  maven {
                      url = uri("https://maven.pkg.github.com/${{ github.repository }}")
                      credentials {
                          username = "YOUR_GITHUB_USERNAME"
                          password = "YOUR_GITHUB_TOKEN"
                      }
                  }
              }
            }

            # build.gradle.kts
            dependencies {
                implementation("com.donglab.devtools:screennameviewer-compose:${{ needs.check-version-change.outputs.new-version }}")
            }
            ```

            **3. ì‚¬ìš© ë°©ë²•**
            - ìì„¸í•œ ì‚¬ìš©ë²•ì€ [README](https://github.com/${{ github.repository }}/blob/main/README.md)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

          draft: false     # ì¦‰ì‹œ ê³µê°œ
          prerelease: false # ì •ì‹ ë¦´ë¦¬ì¦ˆë¡œ ì„¤ì •
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
